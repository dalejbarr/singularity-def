#!/bin/bash -eu
#########################################################
## DO NOT EDIT THIS FILE!
##
## edit script_master.org in emacs and then tangle
## using C-c C-v t
#########################################################

## first argument:  name of R script
## second argument: number of Monte Carlo runs
## third argument:  effect size for A
## fourth argument: effect size for B
## fifth argument:  effect size for AB 
## sixth argument:  (optional) user 'key' for Simplepush mobile app notification

if [ "$#" -lt 5 ];
then
    echo -e "usage:\n\t"`basename "$0"`" script.R number_runs A B AB (simplepush_key)"
    exit
fi

## start timing
SECONDS=0

RSCR=$1
NMC=$2 # number of monte carlo runs
EFF_A=$3
EFF_B=$4
EFF_AB=$5

echo 'Running simulations (may take a long time)...'
FILE=`Rscript $RSCR $EFF_A $EFF_B $EFF_AB $NMC`

duration=$SECONDS
MESSAGE="Completed $NMC runs for $RSCR with ($EFF_A, $EFF_B, $EFF_AB) on $HOSTNAME after $(($duration / 60))m $(($duration % 60))s. Results saved to $FILE"

## upload to server
RES=`curl -s -F name=${FILE} -F data=@${FILE} http://talklab.psy.gla.ac.uk/RData/upload.php`
if [ "$RES" = "Successfully uploaded $FILE" ]; then
    MSG2=" and successfully uploaded to the server."
else
    MSG2=" locally; could not upload to server."
fi


if [ "$#" -ge 6 ];
then
    # push notification to mobile with Simplepush app: need key
    KEY=$6
    curl --data "key=$KEY&title=Done&msg=${MESSAGE}${MSG2}" https://api.simplepush.io/send	
fi

echo ""
echo -e ${MESSAGE}${MSG2}
